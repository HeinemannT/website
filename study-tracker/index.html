<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Tracker // Sleek Edition v6</title>
    <meta name="theme-color" content="#F9FAFB"/> 
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: #F9FAFB; 
            color: #1F2937; 
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .main-layout {
            display: flex;
        }
        .content-area {
            flex-grow: 1;
            /* max-width will be handled by container mx-auto max-w-3xl inside this */
        }
        #tableOfContentsContainer {
            width: 280px; /* Fixed width for ToC */
            flex-shrink: 0;
            position: sticky;
            top: 2rem; /* Adjust as needed */
            height: calc(100vh - 4rem); /* Adjust based on top/bottom padding */
            overflow-y: auto;
            padding-right: 1.5rem; /* Space between ToC and content */
            margin-left: 1.5rem; /* Space from edge or for left-aligned ToC */
            border-left: 1px solid #E5E7EB; /* Subtle separator */
            padding-left: 1rem;
        }
        #tableOfContentsContainer ul {
            list-style: none;
            padding: 0;
        }
        #tableOfContentsContainer li a {
            display: block;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            color: #374151; /* gray-700 */
            border-radius: 6px;
            text-decoration: none;
            transition: background-color 0.2s ease, color 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #tableOfContentsContainer li a:hover {
            background-color: #E5E7EB; /* gray-200 */
            color: #111827; /* gray-900 */
        }
         #tableOfContentsContainer li a.active-toc-link {
            background-color: #DBEAFE; /* blue-100 */
            color: #1D4ED8; /* blue-700 */
            font-weight: 600;
        }


        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .progress-dot {
            width: 7px; height: 7px; border-radius: 50%; border: 1px solid #D1D5DB; 
            margin: 0 2px; background-color: #E5E7EB; 
        }
        .progress-dot.completed { background-color: #10B981; border-color: #059669; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #F3F4F6; }
        ::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #9CA3AF; }

        .subject-progress-visual-blocks {
            width: 100%; height: 20px; 
            background-color: #E5E7EB; display: flex;
            gap: 2px; border-radius: 8px; padding: 2px; overflow: hidden;
        }
        .progress-block-segment {
            flex-grow: 1; height: 100%; background-color: #D1D5DB; /* Default/Not started */
            border-radius: 6px; transition: background-color 0.4s ease-out;
            min-width: 8px; /* Adjusted min-width */
        }
        .progress-block-segment.yellow { background-color: #F59E0B; } /* Started */
        .progress-block-segment.green { background-color: #10B981; } /* Completed */
        .progress-block-segment.no-goals { background-color: #E5E7EB; border: 1px dashed #CBD5E1; } /* Chapter has no goals */


        .chapter-details-collapsible ul { list-style-type: disc; padding-left: 1.25rem; margin-top: 0.5rem; margin-bottom: 0.75rem; color: #4B5563; }
        .chapter-details-collapsible li { margin-bottom: 0.375rem; line-height: 1.5; }
        .detail-section-title { 
            font-weight: 600; color: #111827; margin-top: 1.25rem; 
            margin-bottom: 0.5rem; font-size: 1rem; 
            border-bottom: 1px solid #E5E7EB; padding-bottom: 0.25rem;
        }
        .detail-section-title:first-child { margin-top: 0.5rem; }

        .content-container { 
            border: 1px solid #E5E7EB; padding: 1.5rem; background-color: #ffffff; 
            margin-bottom: 1.5rem; border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); 
        }
        .control-button { 
            background-color: #FFFFFF; color: #374151; border: 1px solid #D1D5DB; 
            padding: 0.625rem 1.25rem; text-decoration: none; cursor: pointer; 
            font-size: 0.875rem; font-weight: 500; border-radius: 8px; 
            transition: background-color 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }
        .control-button:hover { background-color: #F9FAFB; border-color: #9CA3AF; }
        .control-button.active-tab { 
            background-color: #2563EB; color: #FFFFFF; border-color: #2563EB;
            box-shadow: 0 2px 4px rgba(0,0,0,0.07);
        }
        .page-header { font-size: 2rem; font-weight: 700; color: #111827; margin-bottom: 0.5rem; text-align: center; }
        .subject-title-main { font-size: 1.25rem; font-weight: 600; color: #1F2937; text-align: center; }
        
        .chapter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .chapter-title { font-size: 1.125rem; font-weight: 600; color: #1D4ED8; }
        
        .study-guide-details-toggle {
            font-size: 0.875rem; color: #2563EB; cursor: pointer;
            background: none; border: none; padding: 0.25rem 0.5rem;
            display: flex; align-items: center; margin-top: 0.75rem; font-weight: 500;
        }
        .study-guide-details-toggle:hover { text-decoration: underline; }
        .toggle-icon-details { margin-left: 0.3rem; transition: transform 0.2s ease-in-out; font-size: 0.9rem; }
        .toggle-icon-details.rotated { transform: rotate(90deg); }

        .task-checkbox-label { 
            appearance: none; width: 1.125rem; height: 1.125rem; 
            border: 2px solid #CBD5E1; background-color: #fff; 
            margin-right: 0.75rem; cursor: pointer; position: relative; 
            border-radius: 4px; flex-shrink: 0;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .task-checkbox-label:checked { background-color: #2563EB; border-color: #1D4ED8; }
        .task-checkbox-label:checked::after { 
            content: '✔'; font-size: 0.875rem; color: #fff; 
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); font-weight: bold;
        }
        .overall-progress-section { 
            margin-bottom: 1rem; padding: 1rem; border: 1px solid #E5E7EB; 
            background-color: #FFFFFF; border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }
        .overall-progress-title { 
            font-size: 0.875rem; font-weight: 600; color: #374151; 
            margin-bottom: 0.5rem; 
        }
        .task-item-div { 
            display: flex; align-items: center; margin-bottom: 0.625rem; 
            padding: 0.5rem 0.25rem; 
            border-radius: 6px; transition: background-color 0.15s ease;
        }
        .task-item-div:hover { background-color: #F3F4F6; }
        .task-description-label { 
            font-size: 0.9375rem; color: #374151; 
        }
        .task-description-label.completed { text-decoration: line-through; color: #9CA3AF; }
        .chapter-card { 
             margin-bottom: 1.25rem; padding: 1.25rem; background-color: #FFFFFF;
             border: 1px solid #E5E7EB; border-radius: 10px; 
             box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .trackable-goals-title {
            font-weight: 600; color: #111827; margin-top: 1.25rem; 
            margin-bottom: 0.75rem; font-size: 1rem;
            border-top: 1px solid #E5E7EB; padding-top: 1.25rem;
        }
        /* Hide ToC on smaller screens */
        @media (max-width: 1024px) { /* lg breakpoint in Tailwind */
            #tableOfContentsContainer {
                display: none;
            }
            .main-layout > .content-area { /* Ensure content area takes full width when ToC is hidden */
                 width: 100%;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="main-layout container mx-auto">
        <div class="content-area">
            <div class="max-w-3xl mx-auto"> <header class="mb-8">
                    <h1 class="page-header">Study Progress Tracker</h1>
                    <p class="text-sm text-center text-gray-500" id="progressHint">Progress saved locally to this browser.</p>
                </header>

                <div id="messageArea" class="hidden p-3 mb-4 rounded-lg text-sm fixed top-5 right-5 z-50 shadow-lg"></div>

                <div id="overallProgressArea" class="mb-8 space-y-4">
                    <div class="overall-progress-section">
                        <p class="overall-progress-title">SCRUM MASTER CERTIFICATION</p>
                        <div id="overall-scrum-progress-blocks" class="subject-progress-visual-blocks"></div>
                        <p id="overall-scrum-progress-text" class="text-xs text-gray-500 text-right mt-1">0%</p>
                    </div>
                    <div class="overall-progress-section">
                        <p class="overall-progress-title">ISO 27001 LEAD AUDITOR</p>
                        <div id="overall-iso27001-progress-blocks" class="subject-progress-visual-blocks"> </div>
                        <p id="overall-iso27001-progress-text" class="text-xs text-gray-500 text-right mt-1">0%</p> </div>
                </div>

                <div class="mb-6 flex justify-center space-x-2">
                    <button data-tab="scrumTab" class="control-button active-tab flex-1 sm:flex-none">SCRUM Master</button>
                    <button data-tab="iso27001Tab" class="control-button flex-1 sm:flex-none">ISO 27001 Lead Auditor</button>
                </div>

                <div id="scrumTab" class="tab-content active content-container"></div>
                <div id="iso27001Tab" class="tab-content content-container"></div>
                
                <div id="loadingIndicator" class="text-center py-10 content-container">
                    <p class="text-gray-600">Loading study plan...</p>
                </div>
            </div>
        </div>
        <aside id="tableOfContentsContainer" class="hidden lg:block"> 
            <h4 class="text-lg font-semibold text-gray-800 mb-3 sticky top-0 bg-white bg-opacity-80 backdrop-blur-sm py-3 -ml-4 pl-4 border-b border-gray-200">Table of Contents</h4>
            <ul id="tocList" class="space-y-1">
                </ul>
        </aside>
    </div>

    <script type="module">
        const studyPlanData = { // Using the detailed studyPlanData from revised_study_plan_content_v4
            scrum: {
                id: "scrum",
                title: "SCRUM Master Focus",
                chapters: [
                    {
                        id: "scrum_c1", title: "1. Agile Manifesto & Scrum Foundations",
                        importance: "This is the philosophical bedrock. The Agile Manifesto provides the 'why' behind agile practices, and understanding Scrum's empirical nature (Transparency, Inspection, Adaptation) is essential for applying the framework correctly. Certifications heavily test your grasp of these core principles as they influence all roles, events, and artifacts.",
                        objectives: ["Internalize the 4 Values of the Agile Manifesto and be able to explain their practical implications.", "Articulate the 12 Principles behind the Agile Manifesto and link them to Scrum practices.", "Clearly define Empiricism and its three pillars (Transparency, Inspection, Adaptation) as the foundation of Scrum.", "Understand that Scrum is a framework, not a methodology, and identify what makes it lightweight yet effective for complex product development."],
                        estimatedTime: "5-6 hours",
                        revisitPoints: ["The 4 Agile Values (verbatim and their deeper meaning).", "The 12 Agile Principles (especially those relating to customer value, working software, sustainable pace, and self-organizing teams).", "The three pillars of Empiricism and concrete examples of how Scrum implements each.", "The definition of Scrum from the Scrum Guide – pay attention to its intended use for complex problems."],
                        keyConcepts: ["Agile Manifesto: 4 Values, 12 Principles", "Empiricism: Transparency, Inspection, Adaptation", "Iterative and Incremental Development", "Complex Adaptive Problems", "Framework vs. Methodology", "Lean Thinking"],
                        studyTips: ["Read the official Agile Manifesto (agilemanifesto.org) and the Scrum Guide thoroughly. These are primary sources.", "For each Agile Value and Principle, write down how it is (or could be) manifested in a Scrum context.", "Create a mind map linking Empiricism and its pillars to specific Scrum Events and Artifacts.", "Reflect on projects you've been involved in: How could Agile principles or an empirical approach have improved them?", "Discuss these foundational concepts with peers or in online forums to gain different perspectives."],
                        studyGoals: [ 
                            { id: "s_c1_sg1", description: "Be able to explain the 4 Agile Values and their significance." },
                            { id: "s_c1_sg2", description: "Understand and articulate at least 6 Agile Principles and their connection to Scrum." },
                            { id: "s_c1_sg3", description: "Clearly define Empiricism and illustrate each pillar with a practical Scrum example." },
                            { id: "s_c1_sg4", description: "Differentiate between a framework (like Scrum) and a prescriptive methodology." },
                            { id: "s_c1_sg5", description: "Understand the core purpose of Scrum as defined in the Scrum Guide." }
                        ]
                    },
                    {
                        id: "scrum_c2", title: "2. The Scrum Values",
                        importance: "The Scrum Values (Commitment, Courage, Focus, Openness, and Respect) are the lifeblood...",
                        objectives: ["List and define each Scrum Value.", "Provide behavioral examples...", "Explain how Values enable Scrum pillars...", "Understand SM's role in fostering Values..."],
                        estimatedTime: "3-4 hours",
                        revisitPoints: ["Definition and essence of each Value.", "Link between Values and teamwork.", "Scenarios of lacking Values.", "SM's role in nurturing Values."],
                        keyConcepts: ["Commitment", "Courage", "Focus", "Openness", "Respect"],
                        studyTips: ["Brainstorm positive/negative behaviors for each Value.", "Relate Values to empiricism.", "Analyze real-life team scenarios for Values."],
                        studyGoals: [
                            { id: "s_c2_sg1", description: "Be able to define each of the five Scrum Values and explain its importance." },
                            { id: "s_c2_sg2", description: "Identify observable behaviors that demonstrate (or contradict) each Scrum Value in a team setting." },
                            { id: "s_c2_sg3", description: "Understand how the Scrum Values underpin the pillars of empiricism." },
                            { id: "s_c2_sg4", description: "Articulate the Scrum Master's responsibility in promoting the Scrum Values." }
                        ]
                    },
                    {
                        id: "scrum_c3", title: "3. The Scrum Team – Accountabilities & Dynamics",
                        importance: "Scrum defines three specific accountabilities...",
                        objectives: ["Detail PO accountabilities...", "Detail SM accountabilities...", "Detail Developers' accountabilities...", "Explain Scrum Team characteristics...", "Describe collaborations and dysfunctions..."],
                        estimatedTime: "4-5 hours",
                        revisitPoints: ["PO is one person...", "SM is a servant-leader...", "Developers are collectively accountable...", "Team size rationale...", "Self-management & cross-functionality..."],
                        keyConcepts: ["Product Owner", "Scrum Master", "Developers", "Self-Management", "Cross-Functionality", "Accountability", "Product Goal", "Sprint Goal", "Definition of Done"],
                        studyTips: ["Create a role comparison chart...", "Imagine a 'Day in the Life' for each role...", "Analyze common role anti-patterns...", "Focus on the meaning of 'Accountability'..."],
                        studyGoals: [
                            { id: "s_c3_sg1", description: "Clearly define the accountabilities of the Product Owner, Scrum Master, and Developers." },
                            { id: "s_c3_sg2", description: "Understand the concept of a self-managing and cross-functional Scrum Team." },
                            { id: "s_c3_sg3", description: "Explain how the Scrum Master serves the Product Owner, the Developers, and the organization." },
                            { id: "s_c3_sg4", description: "Identify potential challenges and solutions related to Scrum Team dynamics." }
                        ]
                    },
                    {
                        id: "scrum_c4", title: "4. The Scrum Events – The Heartbeat of Empiricism",
                        importance: "The five Scrum Events are formal opportunities...",
                        objectives: ["List and describe all five Events...", "For each Event: purpose, time-box, attendees, inputs/outputs...", "Explain The Sprint as a container...", "Detail Sprint Planning topics...", "Understand Daily Scrum purpose...", "Clarify Sprint Review purpose...", "Explain Sprint Retrospective purpose..."],
                        estimatedTime: "6-7 hours",
                        revisitPoints: ["Exact purpose of each event...", "Daily Scrum is for Developers...", "Sprint Review is a working session...", "Sprint Retrospective yields actionable improvements...", "SM's role in effective events...", "Sprint Goal's importance..."],
                        keyConcepts: ["The Sprint", "Sprint Planning", "Daily Scrum", "Sprint Review", "Sprint Retrospective", "Time-boxing", "Sprint Goal"],
                        studyTips: ["Create a detailed event table...", "Visualize event flow...", "Practice explaining events concisely...", "Identify how each event supports TIA..."],
                        studyGoals: [
                            { id: "s_c4_sg1", description: "Be able to describe the purpose, maximum time-box, and key participants for each of the five Scrum Events." },
                            { id: "s_c4_sg2", description: "Understand how each Scrum Event facilitates Transparency, Inspection, and Adaptation." },
                            { id: "s_c4_sg3", description: "Explain the three topics of Sprint Planning and their outcomes." },
                            { id: "s_c4_sg4", description: "Differentiate the purpose and outcomes of the Sprint Review versus the Sprint Retrospective." }
                        ]
                    },
                    {
                        id: "scrum_c5", title: "5. Scrum Artifacts & Commitments – Providing Transparency",
                        importance: "Scrum's artifacts represent work or value...",
                        objectives: ["Identify and describe the three Artifacts...", "For each Artifact: purpose, accountability, Commitment...", "Explain Product Backlog characteristics...", "Explain Sprint Backlog components...", "Explain Increment characteristics...", "Understand Definition of Done's role..."],
                        estimatedTime: "5-6 hours",
                        revisitPoints: ["Product Backlog is ordered...", "Sprint Backlog belongs to Developers...", "Increment must be usable & meet DoD...", "DoD is crucial for quality...", "Purpose of each Commitment..."],
                        keyConcepts: ["Product Backlog", "Sprint Backlog", "Increment", "Product Goal", "Sprint Goal", "Definition of Done (DoD)", "Transparency", "Emergence"],
                        studyTips: ["Diagram artifact-commitment links...", "Explain artifact transparency...", "Consider impact of weak commitments...", "Draft a sample DoD for a non-software item..."],
                        studyGoals: [
                            { id: "s_c5_sg1", description: "Define each of the three Scrum Artifacts and their corresponding Commitments." },
                            { id: "s_c5_sg2", description: "Understand who is accountable for each Scrum Artifact." },
                            { id: "s_c5_sg3", description: "Explain the importance of the Definition of Done and how it contributes to a usable Increment." },
                            { id: "s_c5_sg4", description: "Describe how the Product Goal, Sprint Goal, and Definition of Done provide clarity and focus." }
                        ]
                    }
                ]
            },
            iso27001: {
                id: "iso27001", // Ensure this ID matches what the JS expects for overall progress bar
                title: "ISO 27001 Lead Auditor Focus",
                chapters: [ 
                    // --- Section A: Information Security ---
                    {
                        id: "iso_A1", title: "A.1: Information Security & Its Significance",
                        importance: "A Lead Auditor must possess a profound understanding of what information security entails beyond technical controls...",
                        objectives: ["Articulate a comprehensive definition of information security.", "Explain the strategic importance of information security...", "Understand and be able to explain the core principles: Confidentiality, Integrity, and Availability (CIA Triad)...", "Identify different types of information assets and their value..."],
                        estimatedTime: "4-6 hours",
                        revisitPoints: ["Strategic business drivers for information security.", "The CIA Triad – definitions and implications of breaches.", "Valuation of information assets (tangible and intangible).", "The role of information security in building and maintaining stakeholder trust."],
                        keyConcepts: ["Information Security Definition", "Confidentiality", "Integrity", "Availability (CIA Triad)", "Information Assets (types and examples)", "Business Impact of Security Breaches", "Stakeholder Confidence", "Strategic Alignment of InfoSec"],
                        studyTips: ["Analyze case studies of major security breaches...", "Consider an organization you know: list its key information assets...", "Relate the concept of 'due care' and 'due diligence'..."],
                        studyGoals: [
                            { id: "iso_A1_sg1", description: "Be able to define Information Security and explain its strategic importance to a business." },
                            { id: "iso_A1_sg2", description: "Understand and clearly explain Confidentiality, Integrity, and Availability with distinct examples for each." },
                            { id: "iso_A1_sg3", description: "Identify at least five different types of information assets and discuss their potential value." },
                            { id: "iso_A1_sg4", description: "Explain how effective information security can be a business enabler rather than just a cost center." }
                        ]
                    },
                    {
                        id: "iso_A2", title: "A.2: Relevant Standards Overview",
                        importance: "The ISO 27000 series forms the core of ISMS knowledge...",
                        objectives: ["Understand the structure, purpose, and scope of ISO/IEC 27001:2022.", "Explain the role of ISO/IEC 27002:2022...", "Utilize ISO/IEC 27000:2018 for key ISMS vocabulary...", "Describe how the principles and framework of ISO 31000:2018 inform...", "Understand the context provided by ISO/IEC 17021-1...", "Internalize ISO/IEC 19011:2018 as the guideline..."],
                        estimatedTime: "8-10 hours",
                        revisitPoints: ["The distinction between 'requirements' (ISO 27001) and 'guidance' (ISO 27002, ISO 27005, ISO 31000).", "Key definitions from ISO 27000...", "The structure of ISO 27001:2022...", "The relationship between ISO 27001 Annex A and ISO 27002...", "Core principles of risk management (ISO 31000)."],
                        keyConcepts: ["ISO/IEC 27001:2022 (Clauses, Annex A)", "ISO/IEC 27002:2022 (Control themes, attributes, guidance)", "ISO/IEC 27000:2018 (Vocabulary)", "ISO 31000:2018 (Risk management principles, framework, process)", "ISO/IEC 19011:2018 (Auditing guidelines)", "ISO/IEC 17021-1 (Conformity assessment requirements for CBs)", "Normative vs. Informative content"],
                        studyTips: ["Obtain and read the actual standards...", "Create a matrix showing how specific clauses of ISO 27001 relate to guidance in ISO 27002 or principles in ISO 31000.", "Familiarize yourself with the Annex A control themes and attributes from ISO 27002:2022."],
                        studyGoals: [
                            { id: "iso_A2_sg1", description: "Be able to explain the primary purpose of ISO 27001, ISO 27002, ISO 27000, ISO 31000, and ISO 19011." },
                            { id: "iso_A2_sg2", description: "Understand the structure of ISO 27001:2022, including the main clauses and the purpose of Annex A." },
                            { id: "iso_A2_sg3", description: "Explain how ISO 27002 is used in conjunction with ISO 27001 Annex A." },
                            { id: "iso_A2_sg4", description: "Articulate key risk management principles from ISO 31000 relevant to an ISMS." },
                            { id: "iso_A2_sg5", description: "Understand the role of ISO 19011 in guiding the audit process." }
                        ]
                    },
                    {
                        id: "iso_A3", title: "A.3: Cybersecurity Legislation",
                        importance: "An ISMS must operate within and ensure compliance with a multitude of legal, statutory, regulatory, and contractual requirements...",
                        objectives: ["Understand the organization's responsibility to identify and comply with applicable cybersecurity and data privacy laws.", "Identify common categories of relevant legislation...", "Explain how organizations can maintain awareness of and ensure compliance with these evolving legal frameworks.", "Understand the implications of non-compliance..."],
                        estimatedTime: "5-7 hours",
                        revisitPoints: ["ISO 27001 Clause 4.2.c (interested parties' requirements, including legal).", "ISO 27001 Annex A controls A.5.31, A.5.32, A.5.33, A.5.34.", "The concept of a 'legal register'...", "The importance of considering legal requirements during risk assessment..."],
                        keyConcepts: ["Data Protection Laws (e.g., GDPR, CCPA)", "Cybercrime Legislation", "Industry-Specific Regulations", "Intellectual Property Law", "Contractual Obligations", "Compliance Management", "Legal & Regulatory Risk"],
                        studyTips: ["Research key cybersecurity and data privacy laws...", "Consider specific industries and the types of additional regulations they might face.", "Think about how an organization would demonstrate to an auditor that it is meeting its legal obligations..."],
                        studyGoals: [
                            { id: "iso_A3_sg1", description: "Be able to identify several types of cybersecurity-related legislation relevant to organizations." },
                            { id: "iso_A3_sg2", description: "Understand the process an organization should follow to identify and manage its legal and regulatory obligations for information security (related to ISO 27001 A.5.31)." },
                            { id: "iso_A3_sg3", description: "Explain the potential consequences for an organization of failing to comply with relevant cybersecurity legislation." },
                            { id: "iso_A3_sg4", description: "Understand how contractual requirements with third parties can impose information security obligations." }
                        ]
                    },
                    {
                        id: "iso_A4", title: "A.4: Assessing Security Vulnerabilities & Threats",
                        importance: "The ability to systematically identify, analyze, and evaluate information security threats and vulnerabilities is a cornerstone of effective risk assessment...",
                        objectives: ["Define 'threat' and 'vulnerability' in the context of information security...", "Understand various sources for threat intelligence and vulnerability information.", "Describe common methodologies and techniques for identifying threats...", "Explain how organizations link identified threats and vulnerabilities to specific information assets..."],
                        estimatedTime: "6-8 hours",
                        revisitPoints: ["The relationship: Asset + Vulnerability + Threat = Risk.", "Different categories of threats and vulnerabilities...", "The importance of a repeatable and systematic process for identification.", "ISO 27001 Clause 6.1.2.c & 6.1.2.d."],
                        keyConcepts: ["Threat Source/Agent", "Threat Event", "Vulnerability", "Exploit", "Attack Vector", "Threat Modelling (e.g., STRIDE)", "Vulnerability Scanning", "Penetration Testing", "Security Assessments", "Common Vulnerabilities and Exposures (CVE)", "Common Weakness Enumeration (CWE)"],
                        studyTips: ["For a given information asset, brainstorm potential threats and vulnerabilities.", "Research common vulnerability databases like CVE.", "Explore basic threat modeling concepts..."],
                        studyGoals: [
                            { id: "iso_A4_sg1", description: "Be able to clearly define 'threat' and 'vulnerability' and provide multiple examples of each." },
                            { id: "iso_A4_sg2", description: "Understand common methods organizations use to identify threats and vulnerabilities." },
                            { id: "iso_A4_sg3", description: "Explain how identified threats and vulnerabilities are typically documented and analyzed as part of a risk assessment." },
                            { id: "iso_A4_sg4", description: "Recognize the importance of considering both internal and external threat sources." }
                        ]
                    },
                    {
                        id: "iso_A5", title: "A.5: Managing Information Security Risks",
                        importance: "Risk management is the central theme of ISO 27001...",
                        objectives: ["Understand the requirements of ISO 27001 Clause 6.1.2 and 6.1.3.", "Explain the components of a risk management process...", "Describe different risk treatment options...", "Understand the purpose, content, and importance of the Statement of Applicability (SoA).", "Explain the concept of risk acceptance criteria and residual risk."],
                        estimatedTime: "8-10 hours",
                        revisitPoints: ["All sub-clauses of 6.1.2 and 6.1.3.", "The SoA as a key auditable document.", "The link between risk assessment results, risk treatment decisions, and Annex A controls.", "The role of risk owners.", "Continual monitoring and review of risks."],
                        keyConcepts: ["Risk Management Process (ISO 31000 context)", "Risk Criteria (including risk acceptance criteria)", "Risk Identification", "Risk Analysis (Likelihood, Impact/Consequence)", "Risk Evaluation", "Risk Treatment Options", "Risk Treatment Plan", "Statement of Applicability (SoA)", "Residual Risk", "Risk Owner", "Information Security Risk"],
                        studyTips: ["Create a detailed flowchart of an ISO 27001 compliant risk assessment and treatment process.", "Take a sample set of risks and walk through how they might be analyzed, evaluated, and treated...", "Review ISO 27005 for detailed guidance..."],
                        studyGoals: [
                            { id: "iso_A5_sg1", description: "Be able to explain the entire information security risk management process as required by ISO 27001 (Clauses 6.1.2 & 6.1.3)." },
                            { id: "iso_A5_sg2", description: "Understand the four main risk treatment options and when each might be appropriate." },
                            { id: "iso_A5_sg3", description: "Clearly define the Statement of Applicability (SoA) and its purpose in an ISMS." },
                            { id: "iso_A5_sg4", description: "Explain how an organization determines risk acceptance criteria and manages residual risks." },
                            { id: "iso_A5_sg5", description: "Understand the importance of assigning risk ownership." }
                        ]
                    },
                    {
                        id: "iso_A6", title: "A.6: Use of Software/Tools in ISMS",
                        importance: "While not mandatory, many organizations use tools... Lead Auditors should understand how these tools can contribute...",
                        objectives: ["Identify common types of tools used in ISMS management...", "Understand the benefits and potential pitfalls of using tools...", "Focus on how to audit the ISMS process itself, even when it is tool-assisted..."],
                        estimatedTime: "2-3 hours",
                        revisitPoints: ["Tools as enablers, not replacements for processes.", "Verifying the configuration and appropriate use of tools...", "Integrity of data produced by tools."],
                        keyConcepts: ["GRC Tools", "Vulnerability Scanners", "SIEM Systems", "Document Management Systems", "Log Analyzers", "Tool Validation/Verification"],
                        studyTips: ["Research some popular GRC or SIEM tools...", "Consider how an auditor would gain assurance that a report generated by a tool is accurate..."],
                        studyGoals: [
                            { id: "iso_A6_sg1", description: "Be able to list categories of tools commonly used to support an ISMS and their general purpose." },
                            { id: "iso_A6_sg2", description: "Understand that the audit focus remains on the ISMS process and its conformity, not the tool itself." },
                            { id: "iso_A6_sg3", description: "Recognize how tool-generated outputs (e.g., scan reports) can serve as audit evidence." }
                        ]
                    },

                    // --- Section B: Management System ---
                    {
                        id: "iso_B1", title: "B.1: ISMS & Data Protection",
                        importance: "Integrating data protection (privacy) requirements into the ISMS is crucial...",
                        objectives: ["Understand the relationship and distinctions between information security and data protection.", "Identify key data protection principles...", "Recognize how ISO 27001 and ISO 27701 (PIMS) can work together.", "Understand how to look for evidence that data protection requirements are considered in the ISMS."],
                        estimatedTime: "4-6 hours",
                        revisitPoints: ["ISO 27001 Annex A controls related to PII...", "Concept of Privacy by Design/Default.", "Data Protection Impact Assessments (DPIA)."],
                        keyConcepts: ["PII (Personally Identifiable Information)", "Data Controller vs. Data Processor", "Data Subject Rights", "Privacy Principles", "ISO/IEC 27701 (PIMS)"],
                        studyTips: ["Compare the objectives of information security (CIA) with the objectives of data privacy.", "Review Annex A controls that have specific privacy considerations..."],
                        studyGoals: [
                            { id: "iso_B1_sg1", description: "Be able to explain the key differences and overlaps between information security and data protection." },
                            { id: "iso_B1_sg2", description: "Understand fundamental data privacy principles." },
                            { id: "iso_B1_sg3", description: "Identify how an ISMS can support compliance with data protection regulations." },
                            { id: "iso_B1_sg4", description: "Recognize the role of ISO 27701 as an extension to ISO 27001 for privacy management." }
                        ]
                    },
                    {
                        id: "iso_B2", title: "B.2: Process-Oriented Approach & PDCA in ISMS",
                        importance: "ISO 27001 is built upon a process approach and the PDCA cycle...",
                        objectives: ["Explain the benefits of a process-oriented approach...", "Clearly map ISO 27001:2022 clauses 4 through 10 to PDCA.", "Understand how PDCA drives continual improvement..."],
                        estimatedTime: "4-5 hours",
                        revisitPoints: ["Specific ISO 27001 clauses for each PDCA phase.", "Flow of information between PDCA phases.", "Continual improvement as an ongoing activity."],
                        keyConcepts: ["Process Approach", "PDCA Cycle (Plan-Do-Check-Act)", "Management System Processes", "Interrelation of Processes", "Continual Improvement Philosophy"],
                        studyTips: ["Create a visual diagram of PDCA mapping to ISO 27001 clauses.", "Trace a specific ISMS process (e.g., incident management) through the PDCA cycle."],
                        studyGoals: [
                            { id: "iso_B2_sg1", description: "Be able to explain the PDCA cycle and its application to an ISMS." },
                            { id: "iso_B2_sg2", description: "Map ISO 27001 clauses 4-10 to the appropriate PDCA phase." },
                            { id: "iso_B2_sg3", description: "Understand how the 'Check' phase provides input for the 'Act' phase." }
                        ]
                    },
                     {
                        id: "iso_B3", title: "B.3: ISMS Process Landscape & Documented Information",
                        importance: "An effective ISMS relies on a well-defined set of processes and appropriate documented information...",
                        objectives: ["Identify key processes that typically form an ISMS process landscape.", "Understand the requirements of ISO 27001 Clause 7.5 (Documented Information)...", "Differentiate between 'maintaining' and 'retaining' documented information.", "Recognize the types of documented information explicitly required by ISO 27001:2022."],
                        estimatedTime: "5-7 hours",
                        revisitPoints: ["Clause 7.5 in its entirety.", "Key documents: ISMS Scope, InfoSec Policy, Risk Assessment/Treatment documentation, SoA, etc."],
                        keyConcepts: ["ISMS Processes", "Documented Information (Policy, Procedure, Record)", "Control of Documented Information (7.5.3)"],
                        studyTips: ["Create a list of all mandatory documented information in ISO 27001:2022.", "Review Clause 7.5 carefully..."],
                        studyGoals: [
                            { id: "iso_B3_sg1", description: "Be able to identify at least five key processes within a typical ISMS." },
                            { id: "iso_B3_sg2", description: "Understand the requirements of ISO 27001 Clause 7.5 concerning documented information." },
                            { id: "iso_B3_sg3", description: "Distinguish between 'maintaining' and 'retaining' documented information, with examples." },
                            { id: "iso_B3_sg4", description: "List at least five pieces of documented information explicitly required by ISO 27001:2022." }
                        ]
                    },
                    {
                        id: "iso_B4", title: "B.4: ISMS Lifecycle (Clauses 4-10 Deep Dive)",
                        importance: "This involves a thorough understanding of ISO 27001 clauses 4-10 from the perspective of establishing, implementing, maintaining, and continually improving the ISMS itself...",
                        objectives: ["For each clause (4-10), understand its core requirements and intent for the ISMS.", "Explain how top management demonstrates leadership and commitment (Clause 5).", "Describe the ISMS planning process (Clause 6).", "Understand requirements for Support (Clause 7) and Operation (Clause 8).", "Describe processes for Performance Evaluation (Clause 9) and Improvement (Clause 10)."],
                        estimatedTime: "12-15 hours",
                        revisitPoints: ["All 'shall' statements in Clauses 4-10.", "Role of Top Management (Clause 5).", "Risk-based thinking.", "Monitoring, measurement, analysis, evaluation (9.1).", "Internal audit (9.2) and management review (9.3).", "Nonconformities and corrective actions (10.1)."],
                        keyConcepts: ["Context (4)", "Leadership (5)", "Planning (6)", "Support (7)", "Operation (8)", "Performance Evaluation (9)", "Improvement (10)", "InfoSec Objectives (6.2)", "Resource Management (7.1)", "Competence & Awareness (7.2, 7.3)", "Communication (7.4)", "Operational Planning & Control (8.1)"],
                        studyTips: ["Read ISO 27001:2022 clauses 4-10 multiple times, highlighting every 'shall'.", "For each clause, summarize its main purpose.", "Create a mind map showing interconnections between clauses."],
                        studyGoals: [
                            { id: "iso_B4_sg1", description: "Be able to explain the purpose and key requirements of ISO 27001 Clauses 4 (Context) and 5 (Leadership)." },
                            { id: "iso_B4_sg2", description: "Understand the detailed requirements for ISMS Planning (Clause 6)." },
                            { id: "iso_B4_sg3", description: "Describe the requirements for Support (Clause 7) and Operation (Clause 8) of the ISMS." },
                            { id: "iso_B4_sg4", description: "Explain the processes for Performance Evaluation (Clause 9) and Improvement (Clause 10)." },
                            { id: "iso_B4_sg5", description: "Understand how Clauses 4-10 form a cohesive management system." }
                        ]
                    },
                    {
                        id: "iso_B5", title: "B.5: ISMS Interrelations & Legal Framework Integration",
                        importance: "An ISMS often integrates with other management systems...",
                        objectives: ["Explain how ISO 27001 can integrate with other MSS...", "Describe how ISO 31000 principles support ISO 27001 risk management.", "Reiterate how legal, regulatory, and contractual requirements are integrated..."],
                        estimatedTime: "3-5 hours",
                        revisitPoints: ["Common MSS elements.", "Risk management as a common theme.", "ISMS supporting overall business objectives."],
                        keyConcepts: ["Integrated Management System (IMS)", "Business Continuity (ISO 22301)", "Risk Management Alignment (ISO 31000)", "High-Level Structure (HLS)/Annex L"],
                        studyTips: ["Compare structures of ISO 27001 and another MSS.", "Consider scenarios of integrating ISMS with BCMS."],
                        studyGoals: [
                            { id: "iso_B5_sg1", description: "Understand the benefits of an Integrated Management System (IMS)." },
                            { id: "iso_B5_sg2", description: "Explain how ISO 27001 risk assessment can inform business continuity planning (ISO 22301)." },
                            { id: "iso_B5_sg3", description: "Recognize how the High-Level Structure (Annex L) facilitates MSS integration." }
                        ]
                    },

                    // --- Section C: Auditor-Specific Skills ---
                    {
                        id: "iso_C1", title: "C.1: Lead Auditor Skills, Competencies & Responsibilities",
                        importance: "Beyond technical knowledge of ISO 27001, a Lead Auditor requires specific skills to effectively plan, conduct, lead, and report on an audit, guided by ISO 19011.",
                        objectives: ["Master and apply the Principles of Auditing (ISO 19011, Clause 4).", "Understand managing an audit programme (ISO 19011, Clause 5).", "Be proficient in all stages of performing an audit (ISO 19011, Clause 6).", "Understand auditor competence requirements and Lead Auditor responsibilities (ISO 19011, Clause 7)."],
                        estimatedTime: "10-12 hours",
                        revisitPoints: ["The 7 Principles of Auditing.", "The entire audit lifecycle.", "Effective interviewing, observation, and sampling techniques.", "Writing clear nonconformity statements.", "Managing audit teams."],
                        keyConcepts: ["Audit Principles", "Audit Programme Management", "Audit Plan", "Audit Scope, Objectives, Criteria", "Audit Team", "Opening/Closing Meetings", "Evidence Collection Techniques", "Audit Sampling", "Audit Findings", "Audit Conclusions", "Audit Report", "Corrective Action & Follow-up", "Auditor Competence"],
                        studyTips: ["Thoroughly study ISO 19011:2018, especially clauses 4, 5, 6, and 7.", "Practice writing mock audit findings.", "Role-play audit scenarios.", "Develop personal checklists for each audit phase."],
                        studyGoals: [
                            { id: "iso_C1_sg1", description: "Be able to explain and apply all 7 Principles of Auditing from ISO 19011." },
                            { id: "iso_C1_sg2", description: "Understand the key activities in managing an audit programme." },
                            { id: "iso_C1_sg3", description: "Describe the steps in planning and preparing for an ISMS audit." },
                            { id: "iso_C1_sg4", description: "Master techniques for conducting audit activities (evidence gathering, interviews, observation)." },
                            { id: "iso_C1_sg5", description: "Be able to write clear, evidence-based audit findings and understand an audit report's structure." },
                            { id: "iso_C1_sg6", description: "Understand audit follow-up and verifying corrective actions' effectiveness." },
                            { id: "iso_C1_sg7", description: "Articulate a Lead Auditor's responsibilities in managing an audit team and process." }
                        ]
                    }
                ]
            }
        };

        let allTasks = []; // Represents all trackable study goals
        const LOCAL_STORAGE_KEY = 'studyTrackerProgress_v1.apple.enriched.v6_goals'; 

        function renderSubject(subjectKey) {
            const subjectData = studyPlanData[subjectKey];
            const containerId = `${subjectKey}Tab`;
            const container = document.getElementById(containerId);
            if (!container || !subjectData) { console.error(`Container or data not found for ${subjectKey}`); return; }
            container.innerHTML = ''; 

            const subjectHeaderDiv = document.createElement('div');
            subjectHeaderDiv.className = 'mb-6 text-center';
            const subjectTitleEl = document.createElement('h2');
            subjectTitleEl.className = 'subject-title-main mb-4';
            subjectTitleEl.textContent = subjectData.title;
            subjectHeaderDiv.appendChild(subjectTitleEl);
            container.appendChild(subjectHeaderDiv);

            if (subjectData.chapters && subjectData.chapters.length > 0) {
                subjectData.chapters.forEach(chapter => {
                    const chapterDiv = document.createElement('div');
                    chapterDiv.className = 'chapter-card';
                    chapterDiv.id = `chapter-${chapter.id}`; 

                    const chapterHeader = document.createElement('div');
                    chapterHeader.className = 'chapter-header';
                    const chapterTitleEl = document.createElement('h3');
                    chapterTitleEl.className = 'chapter-title';
                    chapterTitleEl.textContent = chapter.title;
                    chapterHeader.appendChild(chapterTitleEl);

                    const chapterProgressDotsContainer = document.createElement('div');
                    chapterProgressDotsContainer.className = 'flex items-center';
                    chapterProgressDotsContainer.id = `dots-${chapter.id}`;
                    if (chapter.studyGoals && chapter.studyGoals.length > 0) {
                        chapter.studyGoals.forEach(goal => {
                            const dot = document.createElement('div');
                            dot.className = 'progress-dot';
                            dot.id = `dot-${goal.id}`;
                            chapterProgressDotsContainer.appendChild(dot);
                        });
                    }
                    chapterHeader.appendChild(chapterProgressDotsContainer);
                    chapterDiv.appendChild(chapterHeader);
                    
                    const studyGuideToggle = document.createElement('button');
                    studyGuideToggle.className = 'study-guide-details-toggle';
                    studyGuideToggle.innerHTML = `View Study Guide Details <span class="toggle-icon-details ml-1">▶</span>`;
                    
                    const chapterContentDetailsDiv = document.createElement('div');
                    chapterContentDetailsDiv.className = 'chapter-details-collapsible hidden mt-3 pl-1 space-y-4';

                    studyGuideToggle.onclick = (e) => {
                        e.preventDefault();
                        chapterContentDetailsDiv.classList.toggle('hidden');
                        const icon = studyGuideToggle.querySelector('.toggle-icon-details');
                        const isHidden = chapterContentDetailsDiv.classList.contains('hidden');
                        if (icon) {
                            icon.classList.toggle('rotated', !isHidden);
                            icon.textContent = isHidden ? '▶' : '▼';
                        }
                        studyGuideToggle.childNodes[0].nodeValue = isHidden ? 'View Study Guide Details ' : 'Hide Study Guide Details ';
                    };
                    chapterDiv.appendChild(studyGuideToggle);

                    function createDetailSection(title, contentArrayOrString, isList = true) {
                        if (!contentArrayOrString || (Array.isArray(contentArrayOrString) && contentArrayOrString.length === 0 && isList) || (!isList && typeof contentArrayOrString === 'string' && !contentArrayOrString.trim()) ) return;
                        const sectionWrapper = document.createElement('div');
                        const titleEl = document.createElement('h5');
                        titleEl.className = 'detail-section-title';
                        titleEl.textContent = title;
                        sectionWrapper.appendChild(titleEl);
                        if (isList && Array.isArray(contentArrayOrString)) {
                            const listEl = document.createElement('ul');
                            listEl.className = 'text-sm text-gray-700 leading-relaxed list-disc pl-5 space-y-1';
                            contentArrayOrString.forEach(item => { const li = document.createElement('li'); li.textContent = item; listEl.appendChild(li); });
                            sectionWrapper.appendChild(listEl);
                        } else {
                            const contentEl = document.createElement('p');
                            contentEl.className = 'text-sm text-gray-700 leading-relaxed';
                            contentEl.innerHTML = String(contentArrayOrString).replace(/\n/g, '<br>');
                            sectionWrapper.appendChild(contentEl);
                        }
                        chapterContentDetailsDiv.appendChild(sectionWrapper);
                    }

                    createDetailSection("Importance", chapter.importance, false);
                    createDetailSection("Core Learning Objectives", chapter.objectives);
                    createDetailSection("Key Concepts & Terminology", chapter.keyConcepts);
                    createDetailSection("Actionable Study Tips & Techniques", chapter.studyTips);
                    createDetailSection("Estimated Study Time", chapter.estimatedTime, false);
                    createDetailSection("Crucial Revisit Points", chapter.revisitPoints);
                    chapterDiv.appendChild(chapterContentDetailsDiv);

                    if (chapter.studyGoals && chapter.studyGoals.length > 0) {
                        const goalsTitle = document.createElement('h4');
                        goalsTitle.className = 'trackable-goals-title';
                        goalsTitle.textContent = 'Trackable Study Goals';
                        chapterDiv.appendChild(goalsTitle);

                        chapter.studyGoals.forEach(goal => { 
                            const goalState = allTasks.find(t => t.id === goal.id) || { id: goal.id, completed: false };
                            const goalDiv = document.createElement('div');
                            goalDiv.className = 'task-item-div';
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.id = goal.id;
                            checkbox.checked = goalState.completed;
                            checkbox.className = 'task-checkbox-label';
                            checkbox.onchange = () => toggleTaskStatus(goal.id);
                            const label = document.createElement('label');
                            label.htmlFor = goal.id;
                            label.textContent = goal.description;
                            label.className = `task-description-label ${goalState.completed ? 'completed' : ''} cursor-pointer`;
                            label.id = `label-${goal.id}`;
                            goalDiv.appendChild(checkbox); 
                            goalDiv.appendChild(label);
                            chapterDiv.appendChild(goalDiv);
                        });
                    }
                    container.appendChild(chapterDiv);
                });
            } else {
                 container.innerHTML += '<p class="text-center text-gray-500 py-5">No chapters defined for this subject yet.</p>';
            }
        }
        
        function toggleTaskStatus(goalId) {
            const goal = allTasks.find(t => t.id === goalId);
            if (goal) {
                goal.completed = !goal.completed;
                const label = document.getElementById(`label-${goalId}`);
                if (label) label.classList.toggle('completed', goal.completed);
                const dot = document.getElementById(`dot-${goalId}`);
                if (dot) dot.classList.toggle('completed', goal.completed);
                updateProgressIndicators();
                saveProgressToLocalStorage();
            }
        }

        function saveProgressToLocalStorage() {
            try {
                if (!allTasks || !Array.isArray(allTasks)) { console.error("saveProgress: allTasks is not valid."); return; }
                const progressToSave = allTasks.map(task => ({ id: task.id, completed: task.completed }));
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(progressToSave));
            } catch (e) {
                console.error("Error saving progress to LocalStorage:", e);
                showMessage("ERROR: Could not save progress. " + e.message, "error");
            }
        }

        function loadProgressFromLocalStorage() {
            try {
                const savedProgressString = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (savedProgressString) {
                    const savedProgress = JSON.parse(savedProgressString);
                    if (Array.isArray(savedProgress) && allTasks && allTasks.length > 0) {
                        allTasks.forEach(task => {
                            const savedTask = savedProgress.find(st => st.id === task.id);
                            if (savedTask) task.completed = savedTask.completed;
                        });
                    }
                }
            } catch (e) { console.error("Error loading progress from LocalStorage:", e); }
        }
        
        function updateProgressIndicators() {
            try {
                Object.keys(studyPlanData).forEach(subjectKey => {
                    const subject = studyPlanData[subjectKey];
                    const overallBlocksContainer = document.getElementById(`overall-${subjectKey}-progress-blocks`);
                    const overallTextEl = document.getElementById(`overall-${subjectKey}-progress-text`);

                    if (!subject || !subject.chapters || !Array.isArray(subject.chapters) || subject.chapters.length === 0) {
                        if (overallBlocksContainer) overallBlocksContainer.innerHTML = ''; 
                        if (overallTextEl) overallTextEl.textContent = '0%';
                        return;
                    }

                    if (overallBlocksContainer) {
                        overallBlocksContainer.innerHTML = ''; 

                        subject.chapters.forEach(chapter => {
                            if (!chapter || !chapter.id) { 
                                console.warn(`Skipping invalid chapter in ${subjectKey}:`, chapter);
                                return; 
                            }
                            const chapterBlock = document.createElement('div');
                            chapterBlock.className = 'progress-block-segment';
                            chapterBlock.title = chapter.title; 

                            const goals = chapter.studyGoals || [];
                            const totalChapterGoals = goals.length;
                            let completedChapterGoals = 0;

                            if (totalChapterGoals > 0) {
                                goals.forEach(goal => {
                                    if (goal && goal.id) { 
                                        const goalState = allTasks.find(t => t.id === goal.id);
                                        if (goalState && goalState.completed) {
                                            completedChapterGoals++;
                                        }
                                    }
                                });
                                if (completedChapterGoals === totalChapterGoals) chapterBlock.classList.add('green');
                                else if (completedChapterGoals > 0) chapterBlock.classList.add('yellow');
                            } else {
                                chapterBlock.classList.add('no-goals'); 
                            }
                            overallBlocksContainer.appendChild(chapterBlock);
                        });
                    }

                    const allSubjectGoals = [];
                    subject.chapters.forEach(ch => {
                        const goals = ch.studyGoals || [];
                        if (Array.isArray(goals)) goals.forEach(g => { if (g && g.id) allSubjectGoals.push(g.id); });
                    });
                    const totalSubjectGoals = allSubjectGoals.length;
                    let completedOverallSubjectGoals = 0;

                    if (totalSubjectGoals > 0) {
                        allSubjectGoals.forEach(goalId => {
                            const goalState = allTasks.find(t => t.id === goalId);
                            if (goalState && goalState.completed) completedOverallSubjectGoals++;
                        });
                        const subjectProgressPercent = (completedOverallSubjectGoals / totalSubjectGoals) * 100;
                        if (overallTextEl) overallTextEl.textContent = `${Math.round(subjectProgressPercent)}%`;
                    } else {
                        if (overallTextEl) overallTextEl.textContent = '0%';
                    }

                    subject.chapters.forEach(chapter => {
                        const goals = chapter.studyGoals || [];
                        goals.forEach(goal => {
                             const dot = document.getElementById(`dot-${goal.id}`);
                             if (dot) {
                                const goalState = allTasks.find(t => t.id === goal.id);
                                dot.classList.toggle('completed', goalState && goalState.completed);
                             }
                        });
                    });
                });
            } catch (e) { console.error("Error updating progress indicators:", e); }
        }

        function populateTableOfContents(activeSubjectKey) {
            const tocList = document.getElementById('tocList');
            if (!tocList) return;
            tocList.innerHTML = ''; 

            const subject = studyPlanData[activeSubjectKey];
            if (subject && subject.chapters && Array.isArray(subject.chapters)) {
                subject.chapters.forEach(chapter => {
                    if (!chapter || !chapter.id || !chapter.title) return; 
                    const listItem = document.createElement('li');
                    const link = document.createElement('a');
                    link.href = `#chapter-${chapter.id}`;
                    link.textContent = chapter.title; 
                    link.onclick = (e) => {
                        e.preventDefault();
                        const targetElement = document.getElementById(`chapter-${chapter.id}`);
                        if (targetElement) {
                            targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            document.querySelectorAll('#tocList a').forEach(a => a.classList.remove('active-toc-link'));
                            link.classList.add('active-toc-link');
                        }
                    };
                    listItem.appendChild(link);
                    tocList.appendChild(listItem);
                });
            }
        }


        function setupTabs() {
            const tabButtons = document.querySelectorAll('.control-button');
            const tabContents = document.querySelectorAll('.tab-content');
            let initialActiveTabKey = 'scrum'; 

            const activeBtn = Array.from(tabButtons).find(btn => btn.classList.contains('active-tab'));
            if (activeBtn) {
                initialActiveTabKey = activeBtn.dataset.tab.replace('Tab','');
            } else { 
                 if(tabButtons.length > 0) {
                    tabButtons[0].classList.add('active-tab');
                    initialActiveTabKey = tabButtons[0].dataset.tab.replace('Tab','');
                 }
            }
             tabContents.forEach(content => { 
                content.classList.toggle('active', content.id === `${initialActiveTabKey}Tab`);
            });


            tabButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    tabButtons.forEach(btn => btn.classList.remove('active-tab'));
                    button.classList.add('active-tab');
                    const targetTab = button.dataset.tab;
                    let activeKey = '';
                    tabContents.forEach(content => {
                        const isActive = content.id === targetTab;
                        content.classList.toggle('active', isActive);
                        if(isActive) activeKey = content.id.replace('Tab',''); 
                    });
                    populateTableOfContents(activeKey); 
                });
            });
            populateTableOfContents(initialActiveTabKey);
        }
        
        function showMessage(message, type = "info") {
            const messageArea = document.getElementById('messageArea');
            if (!messageArea) return;
            messageArea.textContent = message;
            messageArea.className = 'p-3 mb-4 rounded-lg text-sm fixed top-5 right-5 z-50 shadow-lg ';
            if (type === "error") messageArea.classList.add('bg-red-100', 'text-red-700', 'border', 'border-red-300');
            else if (type === "success") messageArea.classList.add('bg-green-100', 'text-green-700', 'border', 'border-green-300');
            else messageArea.classList.add('bg-blue-100', 'text-blue-700', 'border', 'border-blue-300');
            messageArea.classList.remove('hidden');
            setTimeout(() => { messageArea.classList.add('hidden'); }, 3500);
        }

        function initializeApp() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) loadingIndicator.style.display = 'none';
            allTasks = []; 
            Object.values(studyPlanData).forEach(subject => {
                if (subject && subject.chapters && Array.isArray(subject.chapters)) {
                    subject.chapters.forEach(chapter => {
                        const goals = chapter.studyGoals; 
                        if (goals && Array.isArray(goals)) {
                            goals.forEach(goal => {
                                if(goal && goal.id) { 
                                    allTasks.push({ id: goal.id, completed: false, subjectId: subject.id, chapterId: chapter.id });
                                } else {
                                    console.warn("Malformed goal object in chapter:", chapter.id, goal);
                                }
                            });
                        } else {
                             console.warn("Study goals missing or not an array for chapter:", chapter ? chapter.id : 'undefined chapter', chapter);
                        }
                    });
                } else {
                     console.warn("Subject chapters missing or not an array for subject:", subject ? subject.id : 'undefined subject');
                }
            });
            
            if(allTasks.length === 0 && (studyPlanData.scrum.chapters.length > 0 || studyPlanData.iso27001.chapters.length > 0) ) {
                console.error("CRITICAL: allTasks array is empty after initialization. Check data structure and 'studyGoals' definitions.");
                showMessage("Error: Study plan goals could not be loaded.", "error");
            }
            loadProgressFromLocalStorage();
            renderSubject('scrum');
            renderSubject('iso27001');
            setupTabs(); 
            updateProgressIndicators(); 
        }
        
        window.onload = () => {
            try {
                initializeApp();
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('./sw.js') 
                        .then((reg) => console.log('Service worker registered.', reg.scope))
                        .catch((err) => console.error('Service worker registration failed:', err));
                }
            } catch (e) {
                console.error("CRITICAL ERROR during initialization:", e);
                const loadingIndicator = document.getElementById('loadingIndicator');
                if(loadingIndicator) loadingIndicator.innerHTML = `<p style="color:red;">SYSTEM ERROR. Details: ${e.message}</p>`;
                showMessage("FATAL ERROR: App could not start. " + e.message, "error");
            }
        };
    </script>
</body>
</html>
